<!DOCTYPE html>
<html lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8">
    <title>Book Reservation - Welcome and choose a Book</title>
    <style>
        body { width: 800px; margin: auto; font-family: Arial, sans-serif; }
        h1 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .actions button, .actions a {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .edit-btn { background-color: #5cb85c; color: white; }
        .delete-btn { background-color: #d9534f; color: white; }
        .add-btn { background-color: #007bff; color: white; margin-bottom: 20px; display: block; width: fit-content; }
        .error { color: red; font-weight: bold; margin-bottom: 10px; }
        .reservation-section { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px; }
        .reservation-section label { display: block; margin-bottom: 5px; font-weight: bold; }
        .reservation-section input[type="text"], .reservation-section input[type="number"] {
            width: 50%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;
        }
    </style>
</head>
<body>
<header>
    <h1>Welcome to our Book Reservation App</h1>
    <div style="margin-top:10px">
        <a sec:authorize="isAnonymous()" th:href="@{/login}">Login</a>
        <form sec:authorize="isAuthenticated()" th:action="@{/logout}" method="post" style="display:inline">
            <button type="submit">Logout</button>
        </form>
    </div>
</header>

<main>
    <div th:if="${error}" class="error">
        <span th:text="${error == 'BookNotFound' ? 'Error: Book not found!' : error}">Error!</span>
    </div>

    <a th:href="@{/books/book-form}" class="add-btn" sec:authorize="hasRole('ADMIN')">Add New Book</a>

    <form th:action="@{/books}" method="GET" style="margin-bottom:16px">
        <input type="text" name="text" placeholder="Title contains" th:value="${text}">
        <input type="number" step="0.1" name="rating" placeholder="Min rating" th:value="${rating}">
        <button type="submit">Filter</button>
    </form>

    <form th:action="@{/bookReservation}" method="POST">
        <h2>Choose a book:</h2>
        <table>
            <thead>
            <tr>
                <th>Select</th>
                <th>Title</th>
                <th>Genre</th>
                <th>Rating</th>
                <th>Author</th>
                <th sec:authorize="hasRole('ADMIN')">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="book : ${books}">
                <td>
                    <input type="radio" name="bookTitle" th:value="${book.title}" required/>
                </td>
                <td th:text="${book.title}">Title</td>
                <td th:text="${book.genre}">Genre</td>
                <td th:text="${book.averageRating}">0.0</td>
                <td th:text="${book.author != null ? book.author.name + ' ' + book.author.surname : 'N/A'}">Author Name Surname</td>
                <td class="actions" sec:authorize="hasRole('ADMIN')">
                    <a th:href="@{|/books/book-form/${book.id}|}" class="edit-btn">Edit</a>
                    <button type="button" class="delete-btn" th:onclick="|deleteBook(${book.id})|">Delete</button>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="reservation-section">
            <h2>Enter your information:</h2>

            <label for="readerName">Your Name:</label>
            <input type="text" id="readerName" name="readerName" required/><br/>

            <label for="readerAddress">Your Address:</label>
            <input type="text" id="readerAddress" name="readerAddress" required/><br/>

            <h2>Choose number of copies:</h2>
            <input type="number" name="numCopies" min="1" value="1" required/><br/><br/>

            <button type="submit">Reserve Book</button>
        </div>

    </form>
</main>

<script>
    function deleteBook(bookId) {
        if (confirm('Are you sure you want to delete this book?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/books/delete/' + bookId;
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
</body>
</html>
